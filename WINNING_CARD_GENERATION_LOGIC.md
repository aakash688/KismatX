# Winning Card Generation Logic

## Overview

The winning card is **NOT automatically generated by default**. The system supports **two modes** for determining winning cards:

1. **Manual Mode** (Default) - Admin manually declares the winning card
2. **Auto Mode** - System automatically generates a random winning card

---

## ğŸ”§ Mode Configuration

The mode is controlled by the `game_result_type` setting in the database:

- **`manual`** (Default) - Admin must manually declare the winning card
- **`auto`** - System automatically generates winning card when game completes

You can change this setting via:
- **Admin Panel**: Settings page (`/settings`)
- **API**: `PUT /api/admin/settings` with `{ "game_result_type": "auto" | "manual" }`

---

## ğŸ“‹ Manual Mode (Default)

### How It Works:
1. Game is created and becomes active
2. Players place bets during the game
3. Game ends and status changes to `completed`
4. **Admin must manually declare the winning card** via:
   - **Admin Panel**: Game Detail Page â†’ "Settle Game" button
   - **API**: `POST /api/admin/games/:gameId/settle` with `{ "winning_card": 1-12 }`
5. System calculates payouts and marks game as `settled`

### Process Flow:
```
Game Created â†’ Game Active â†’ Game Completed â†’ [Admin Declares Winning Card] â†’ Game Settled
```

### Benefits:
- Full admin control over results
- Allows for manual verification/validation
- Supports external result sources (e.g., lottery draws, external events)

---

## ğŸ¤– Auto Mode

### How It Works:
1. Game is created and becomes active
2. Players place bets during the game
3. Game ends and status changes to `completed`
4. **System automatically generates a random winning card** (1-12)
5. System automatically settles the game with the generated card

### When Does Auto-Settlement Run?
- **Frequency**: Every **10 seconds** (via setInterval)
- **Condition**: Only if `game_result_type` setting is set to `'auto'`
- **Process**: Finds all completed games with `settlement_status = 'not_settled'` that ended within the last 30 seconds and settles them
- **Timing**: Games are settled within **5-10 seconds** after completion (5-second delay to ensure game is truly completed, then processed within next 10-second check)

### Winning Card Selection Logic:
```javascript
// Random selection (1-12)
const winningCard = Math.floor(Math.random() * 12) + 1;
```

- Uses JavaScript's `Math.random()` function
- Generates a number between 1 and 12 (inclusive)
- Each card (1-12) has an equal probability (1/12 â‰ˆ 8.33%)

### Process Flow:
```
Game Created â†’ Game Active â†’ Game Completed â†’ [Wait 5s] â†’ [Auto: Random Card Generated] â†’ Game Settled (within 10s total)
```

### Benefits:
- Fully automated, no admin intervention needed
- Immediate settlement after game ends
- Fair random selection

---

## âš™ï¸ Technical Implementation

### Auto-Settlement Interval:
```javascript
// Location: src/schedulers/gameScheduler.js
// Runs every 10 seconds: setInterval(..., 10000)

const runAutoSettlement = async () => {
    // Check if auto-settlement is enabled
    const gameResultType = await getSetting('game_result_type', 'manual');
    
    if (gameResultType !== 'auto') {
        return; // Skip if manual mode
    }

    // Find completed games that ended within last 30 seconds
    const gamesToSettle = await gameRepo
        .createQueryBuilder('game')
        .where('game.status = :status', { status: 'completed' })
        .andWhere('game.settlement_status = :settlementStatus', { settlementStatus: 'not_settled' })
        .andWhere('game.end_time >= :thirtySecondsAgo', { thirtySecondsAgo })
        .getMany();

    // For each game, check timing and settle
    for (const game of gamesToSettle) {
        const timeSinceEnd = now.getTime() - game.end_time.getTime();
        
        // Only settle if game ended at least 5 seconds ago
        if (timeSinceEnd >= 5000) {
            const winningCard = Math.floor(Math.random() * 12) + 1;
            await settleGame(game.game_id, winningCard, 1); // admin_id = 1 (system)
        }
    }
};

// Run every 10 seconds
setInterval(runAutoSettlement, 10000);
```

### Settlement Process:
1. Validates game state (must be `completed` and `not_settled`)
2. Updates bet details (marks winners/losers)
3. Calculates payouts (bet_amount Ã— multiplier)
4. Updates bet slips status (`won`/`lost`)
5. Updates game record with `winning_card` and `settlement_status = 'settled'`
6. Creates audit log entry

---

## ğŸ¯ Summary

| Aspect | Manual Mode | Auto Mode |
|--------|------------|-----------|
| **Default** | âœ… Yes | âŒ No |
| **Winning Card** | Admin selects | Random (1-12) |
| **Settlement Time** | When admin declares | Within **5-10 seconds** of game end |
| **Admin Action Required** | âœ… Yes | âŒ No |
| **Fairness** | Depends on admin | Fully random |
| **Control** | Full control | Automated |

---

## ğŸ“ Current Status

**By default, your system is in MANUAL MODE**, which means:
- Winning cards are **NOT automatically generated**
- Admin must manually declare the winning card via the admin panel
- Games will remain in `not_settled` status until admin settles them

To enable auto-mode:
1. Go to Admin Panel â†’ Settings
2. Find `game_result_type` setting
3. Change value from `manual` to `auto`
4. Save settings

---

## ğŸ” Verification

To check current mode:
```sql
SELECT * FROM settings WHERE key = 'game_result_type';
```

Or via API:
```bash
GET /api/admin/settings
# Look for "game_result_type" in response
```

