<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Stock Market Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .search-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .popular-stocks {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stock-chip {
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            border: 2px solid transparent;
        }

        .stock-chip:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .selected-stocks {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .selected-stock-tag {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .remove-stock {
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stock-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stock-card:hover {
            transform: translateY(-5px);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .stock-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        .stock-exchange {
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .stock-price {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .stock-change {
            font-size: 1.2em;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
        }

        .positive {
            color: #10b981;
            background: #d1fae5;
        }

        .negative {
            color: #ef4444;
            background: #fee2e2;
        }

        .stock-details {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .chart-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-controls button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .search-results {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: #f9fafb;
            border-color: #667eea;
        }

        .company-info {
            flex: 1;
        }

        .company-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .company-symbol {
            color: #666;
            font-size: 0.9em;
        }

        .exchange-badges {
            display: flex;
            gap: 5px;
        }

        .exchange-badge {
            padding: 4px 8px;
            background: #e0e0e0;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .exchange-badge:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .search-container {
                flex-direction: column;
            }

            input[type="text"] {
                width: 100%;
            }

            .stock-details {
                grid-template-columns: 1fr;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-data-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        footer {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            color: #666;
        }

        .api-status {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot.error {
            background: #ef4444;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .warning-box h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .warning-box p {
            color: #78350f;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .warning-box code {
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #dc2626;
        }

        .warning-box ol {
            margin-left: 20px;
            color: #78350f;
        }

        .warning-box li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìà Indian Stock Market Dashboard</h1>
            <p class="subtitle">Real-time NSE & BSE Stock Data with Interactive Charts</p>
        </header>

        <div class="warning-box">
            <h3>‚ö†Ô∏è CORS Issue - Please Run on Local Server</h3>
            <p>This dashboard needs to run on a web server due to CORS restrictions. Choose one option:</p>
            <ol>
                <li><strong>Python:</strong> Run <code>python -m http.server 8000</code> then open <code>http://localhost:8000</code></li>
                <li><strong>VS Code:</strong> Install "Live Server" extension and click "Go Live"</li>
                <li><strong>Node.js:</strong> Run <code>npx serve</code> in this folder</li>
                <li><strong>PHP:</strong> Run <code>php -S localhost:8000</code></li>
            </ol>
            <p style="margin-top: 15px;"><strong>Why?</strong> The API requires proper server setup for CORS. It won't work with <code>file://</code> or some local environments.</p>
        </div>

        <div class="api-status">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting to API...</span>
            </div>
            <small id="lastUpdate">Last update: Never</small>
        </div>

        <div class="search-section">
            <h2 style="margin-bottom: 15px; color: #333;">Search & Add Stocks</h2>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search stocks (e.g., Reliance, TCS, HDFC Bank)">
                <button onclick="searchStock()">üîç Search</button>
                <button onclick="addStock()">‚ûï Add by Symbol</button>
                <button onclick="clearAll()">üóëÔ∏è Clear All</button>
                <button onclick="loadDemoData()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%)">üéØ Load Demo</button>
            </div>

            <div id="searchResults" class="search-results"></div>

            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #333;">Popular Stocks</h3>
            <div class="popular-stocks">
                <div class="stock-chip" onclick="addStockBySymbol('RELIANCE.NS')">Reliance</div>
                <div class="stock-chip" onclick="addStockBySymbol('TCS.NS')">TCS</div>
                <div class="stock-chip" onclick="addStockBySymbol('INFY.NS')">Infosys</div>
                <div class="stock-chip" onclick="addStockBySymbol('HDFCBANK.NS')">HDFC Bank</div>
                <div class="stock-chip" onclick="addStockBySymbol('ICICIBANK.NS')">ICICI Bank</div>
                <div class="stock-chip" onclick="addStockBySymbol('ITC.NS')">ITC</div>
                <div class="stock-chip" onclick="addStockBySymbol('SBIN.NS')">SBI</div>
                <div class="stock-chip" onclick="addStockBySymbol('BHARTIARTL.NS')">Airtel</div>
            </div>

            <div id="selectedStocks" class="selected-stocks"></div>
        </div>

        <div id="dashboard" class="dashboard"></div>

        <div id="chartSection" class="chart-section" style="display: none;">
            <div class="chart-header">
                <h2 class="chart-title">Stock Price Comparison</h2>
                <div class="chart-controls">
                    <button onclick="changeChartType('bar')">üìä Bar</button>
                    <button onclick="changeChartType('line')">üìà Line</button>
                    <button onclick="changeChartType('radar')">üéØ Radar</button>
                </div>
            </div>
            <canvas id="stockChart"></canvas>
        </div>

        <footer>
            <p>Data provided by NSE & BSE API | Updates in real-time during market hours</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Market Hours: 9:15 AM - 3:30 PM IST (Mon-Fri)</p>
        </footer>
    </div>

    <script>
        const API_BASE_URL = 'https://nse-api-khaki.vercel.app';
        
        let selectedStockSymbols = [];
        let stocksData = [];
        let chart = null;

        // Demo data for testing
        const DEMO_DATA = {
            status: "success",
            response_format: "numeric_only",
            count: 5,
            stocks: [
                {
                    symbol: "RELIANCE",
                    exchange: "NSE",
                    ticker: "RELIANCE.NS",
                    company_name: "Reliance Industries Limited",
                    last_price: 2456.75,
                    change: 12.30,
                    percent_change: 0.50,
                    volume: 8234567,
                    market_cap: 16645678900000.0,
                    pe_ratio: 27.35,
                    sector: "Energy"
                },
                {
                    symbol: "TCS",
                    exchange: "NSE",
                    ticker: "TCS.NS",
                    company_name: "Tata Consultancy Services Limited",
                    last_price: 3456.75,
                    change: -12.50,
                    percent_change: -0.36,
                    volume: 1234567,
                    market_cap: 12678945000000.0,
                    pe_ratio: 29.35,
                    sector: "Technology"
                },
                {
                    symbol: "INFY",
                    exchange: "NSE",
                    ticker: "INFY.NS",
                    company_name: "Infosys Limited",
                    last_price: 1567.80,
                    change: 8.90,
                    percent_change: 0.57,
                    volume: 34567890,
                    market_cap: 6543210000000.0,
                    pe_ratio: 24.56,
                    sector: "Technology"
                },
                {
                    symbol: "ITC",
                    exchange: "NSE",
                    ticker: "ITC.NS",
                    company_name: "ITC Limited",
                    last_price: 445.50,
                    change: 2.30,
                    percent_change: 0.52,
                    volume: 52345670,
                    market_cap: 5567894500000.0,
                    pe_ratio: 28.45,
                    sector: "Consumer Defensive"
                },
                {
                    symbol: "HDFCBANK",
                    exchange: "NSE",
                    ticker: "HDFCBANK.NS",
                    company_name: "HDFC Bank Limited",
                    last_price: 1645.75,
                    change: -5.25,
                    percent_change: -0.32,
                    volume: 5678901,
                    market_cap: 12456789000000.0,
                    pe_ratio: 19.85,
                    sector: "Financial Services"
                }
            ],
            timestamp: new Date().toISOString()
        };

        // Load demo data
        function loadDemoData() {
            selectedStockSymbols = DEMO_DATA.stocks.map(s => s.ticker);
            stocksData = DEMO_DATA.stocks;
            updateSelectedStocks();
            updateDashboard();
            updateChart();
            updateStatus(true, 'Demo Mode - Using Sample Data');
            updateLastUpdateTime();
        }

        // Update API status
        function updateStatus(connected, message) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.classList.remove('error');
                statusText.textContent = message || 'API Connected';
            } else {
                statusDot.classList.add('error');
                statusText.textContent = message || 'API Connection Failed';
            }
        }

        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Last update: ${now.toLocaleTimeString()}`;
        }

        // Fetch with better error handling
        async function fetchAPI(url) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // Search for stocks
        async function searchStock() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Please enter a search term');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading">üîç Searching...</div>';

            try {
                const url = `${API_BASE_URL}/search?q=${encodeURIComponent(query)}`;
                const data = await fetchAPI(url);

                if (data.status === 'success' && data.results.length > 0) {
                    displaySearchResults(data.results);
                    updateStatus(true, 'API Connected');
                } else {
                    resultsDiv.innerHTML = '<div class="error">No results found. Try searching with stock symbol or company name.</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">
                    <strong>API Connection Error</strong><br>
                    ${error.message}<br><br>
                    <small>Please run this page on a local server. See instructions above.</small><br>
                    <button onclick="loadDemoData()" style="margin-top: 10px;">Try Demo Data Instead</button>
                </div>`;
                updateStatus(false, 'Connection Error');
            }
        }

        // Display search results
        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';

            results.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <div class="company-info">
                        <div class="company-name">${result.company_name}</div>
                        <div class="company-symbol">Symbol: ${result.symbol}</div>
                    </div>
                    <div class="exchange-badges">
                        <div class="exchange-badge" onclick="addStockBySymbol('${result.symbol}.NS')">NSE</div>
                        <div class="exchange-badge" onclick="addStockBySymbol('${result.symbol}.BO')">BSE</div>
                    </div>
                `;
                resultsDiv.appendChild(resultItem);
            });
        }

        // Add stock by symbol directly
        function addStockBySymbol(symbol) {
            if (!selectedStockSymbols.includes(symbol)) {
                selectedStockSymbols.push(symbol);
                updateSelectedStocks();
                fetchAllStocks();
            }
        }

        // Add stock from input
        function addStock() {
            const symbol = document.getElementById('searchInput').value.trim().toUpperCase();
            if (!symbol) {
                alert('Please enter a stock symbol');
                return;
            }

            const finalSymbol = symbol.includes('.') ? symbol : symbol + '.NS';
            addStockBySymbol(finalSymbol);
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // Remove stock
        function removeStock(symbol) {
            selectedStockSymbols = selectedStockSymbols.filter(s => s !== symbol);
            stocksData = stocksData.filter(s => s.ticker !== symbol);
            updateSelectedStocks();
            updateDashboard();
            updateChart();
        }

        // Update selected stocks display
        function updateSelectedStocks() {
            const container = document.getElementById('selectedStocks');
            if (selectedStockSymbols.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '<h3 style="width: 100%; margin-bottom: 10px; color: #333;">Selected Stocks:</h3>';
            selectedStockSymbols.forEach(symbol => {
                const tag = document.createElement('div');
                tag.className = 'selected-stock-tag';
                tag.innerHTML = `
                    ${symbol}
                    <span class="remove-stock" onclick="removeStock('${symbol}')">√ó</span>
                `;
                container.appendChild(tag);
            });
        }

        // Fetch all selected stocks
        async function fetchAllStocks() {
            if (selectedStockSymbols.length === 0) {
                document.getElementById('dashboard').innerHTML = `
                    <div class="no-data" style="grid-column: 1/-1;">
                        <div class="no-data-icon">üìä</div>
                        <h2>No stocks selected</h2>
                        <p>Search and add stocks to view their data</p>
                        <button onclick="loadDemoData()" style="margin-top: 20px;">Load Demo Data</button>
                    </div>
                `;
                return;
            }

            document.getElementById('dashboard').innerHTML = '<div class="loading" style="grid-column: 1/-1;">üìà Loading stock data...</div>';

            try {
                const symbols = selectedStockSymbols.join(',');
                const url = `${API_BASE_URL}/stock/list?symbols=${symbols}&res=num`;
                console.log('Fetching from:', url);
                
                const data = await fetchAPI(url);
                console.log('Response data:', data);

                if (data.status === 'success') {
                    stocksData = data.stocks;
                    updateDashboard();
                    updateChart();
                    updateStatus(true, 'API Connected');
                    updateLastUpdateTime();
                } else {
                    throw new Error(data.message || 'Failed to fetch stock data');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('dashboard').innerHTML = `
                    <div class="error" style="grid-column: 1/-1;">
                        <strong>API Connection Error:</strong> ${error.message}<br><br>
                        <small>Please run this page on a web server to bypass CORS restrictions. See instructions at the top.</small><br><br>
                        <button onclick="loadDemoData()">Load Demo Data Instead</button>
                    </div>
                `;
                updateStatus(false, 'Connection Error - Use Demo');
            }
        }

        // Update dashboard with stock cards
        function updateDashboard() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';

            if (stocksData.length === 0) {
                dashboard.innerHTML = `
                    <div class="no-data" style="grid-column: 1/-1;">
                        <div class="no-data-icon">üìä</div>
                        <h2>No data available</h2>
                        <p>Unable to fetch stock data. Please try again.</p>
                    </div>
                `;
                return;
            }

            stocksData.forEach(stock => {
                const card = createStockCard(stock);
                dashboard.appendChild(card);
            });
        }

        // Create stock card element
        function createStockCard(stock) {
            const card = document.createElement('div');
            card.className = 'stock-card';

            const changeClass = stock.change >= 0 ? 'positive' : 'negative';
            const changeSymbol = stock.change >= 0 ? '‚ñ≤' : '‚ñº';

            card.innerHTML = `
                <div class="stock-header">
                    <div>
                        <div class="stock-name">${stock.symbol}</div>
                        <div style="color: #666; font-size: 0.9em; margin-top: 5px;">${stock.company_name}</div>
                    </div>
                    <div class="stock-exchange">${stock.exchange}</div>
                </div>
                <div class="stock-price">‚Çπ${stock.last_price.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                <div class="stock-change ${changeClass}">
                    ${changeSymbol} ‚Çπ${Math.abs(stock.change).toFixed(2)} (${stock.percent_change.toFixed(2)}%)
                </div>
                <div class="stock-details">
                    <div class="detail-item">
                        <div class="detail-label">Volume</div>
                        <div class="detail-value">${formatVolume(stock.volume)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Market Cap</div>
                        <div class="detail-value">${formatMarketCap(stock.market_cap)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">P/E Ratio</div>
                        <div class="detail-value">${stock.pe_ratio ? stock.pe_ratio.toFixed(2) : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Sector</div>
                        <div class="detail-value" style="font-size: 0.9em;">${stock.sector || 'N/A'}</div>
                    </div>
                </div>
            `;

            return card;
        }

        // Format volume
        function formatVolume(volume) {
            if (!volume) return 'N/A';
            if (volume >= 10000000) {
                return (volume / 10000000).toFixed(2) + ' Cr';
            } else if (volume >= 100000) {
                return (volume / 100000).toFixed(2) + ' L';
            }
            return volume.toLocaleString('en-IN');
        }

        // Format market cap
        function formatMarketCap(cap) {
            if (!cap) return 'N/A';
            if (cap >= 10000000000) {
                return '‚Çπ' + (cap / 10000000000).toFixed(2) + ' K Cr';
            } else if (cap >= 10000000) {
                return '‚Çπ' + (cap / 10000000).toFixed(2) + ' Cr';
            }
            return '‚Çπ' + cap.toLocaleString('en-IN');
        }

        // Update chart
        function updateChart() {
            if (stocksData.length === 0) {
                document.getElementById('chartSection').style.display = 'none';
                return;
            }

            document.getElementById('chartSection').style.display = 'block';

            const ctx = document.getElementById('stockChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const labels = stocksData.map(s => s.symbol);
            const prices = stocksData.map(s => s.last_price);

            const colors = stocksData.map(s => 
                s.change >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'
            );

            const borderColors = stocksData.map(s => 
                s.change >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)'
            );

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock Price (‚Çπ)',
                        data: prices,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const stock = stocksData[context.dataIndex];
                                    return [
                                        `Price: ‚Çπ${stock.last_price.toLocaleString('en-IN')}`,
                                        `Change: ${stock.percent_change.toFixed(2)}%`,
                                        `Volume: ${formatVolume(stock.volume)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toLocaleString('en-IN');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Change chart type
        function changeChartType(type) {
            if (!chart) return;

            chart.destroy();

            const ctx = document.getElementById('stockChart').getContext('2d');
            const labels = stocksData.map(s => s.symbol);
            const prices = stocksData.map(s => s.last_price);

            const colors = stocksData.map(s => 
                s.change >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'
            );

            const borderColors = stocksData.map(s => 
                s.change >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)'
            );

            const chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock Price (‚Çπ)',
                        data: prices,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        fill: type === 'radar'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    }
                }
            };

            if (type !== 'radar') {
                chartConfig.options.scales = {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '‚Çπ' + value.toLocaleString('en-IN');
                            }
                        }
                    }
                };
            }

            chart = new Chart(ctx, chartConfig);
        }

        // Clear all stocks
        function clearAll() {
            if (confirm('Clear all selected stocks?')) {
                selectedStockSymbols = [];
                stocksData = [];
                updateSelectedStocks();
                updateDashboard();
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                document.getElementById('chartSection').style.display = 'none';
                document.getElementById('searchResults').innerHTML = '';
            }
        }

        // Enter key search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });

        // Test API connection on load
        window.addEventListener('load', async function() {
            console.log('Testing API connection...');
            try {
                const data = await fetchAPI(`${API_BASE_URL}/`);
                console.log('API Response:', data);
                updateStatus(true, `API v${data.version} Connected`);
            } catch (error) {
                console.error('API connection failed:', error);
                updateStatus(false, 'CORS Error - Click "Load Demo"');
            }
        });
    </script>
</body>
</html>