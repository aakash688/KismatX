# ğŸ“ System Architecture & Data Flow Diagrams

## ğŸ—ï¸ Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ADMIN PANEL UI (React/TypeScript)                      â”‚
â”‚                         http://localhost:3001                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  StatsPage Component (/stats)                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ 1. Filters Section                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ Start Date Input    â”€â”€â”€â”€â”€â”                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ End Date Input      â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ Trigger: onChange         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ User Dropdown       â”€â”€â”€â”€â”€â”¤                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â””â”€ Generate Button     â”€â”€â”€â”€â”€â”˜                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 2. Stats Cards (6 columns)                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ Total Users                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ Active Users                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ Total Games                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ Total Wagered      â† NEEDS REAL DATA                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ Total Payouts      â† NEEDS REAL DATA                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â””â”€ Profit/Loss        â† NEEDS REAL DATA                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 3. Charts & Tables (Future)                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ Line Chart: Wagered vs Payouts over time                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â”œâ”€ Bar Chart: Per-card statistics                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â””â”€ Table: Per-user breakdown                                â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                â†“                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ services/services.ts                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ statsService.getStats({                                   â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚   startDate: "2024-11-01",                               â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚   endDate: "2024-11-12",                                 â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚   userId: null                                           â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ })                                                        â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚                                                            â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ Returns: Promise<StatsResponse>                          â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                â†“                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ services/api.ts (Axios Client)                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ POST http://localhost:5001/api/admin/stats               â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚                                                            â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ Interceptor: Adds Authorization Header                   â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â”‚ Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...          â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP POST /api/admin/stats
                 â”‚ Content-Type: application/json
                 â”‚ Authorization: Bearer <JWT_TOKEN>
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BACKEND API (Express + TypeORM)                          â”‚
â”‚                        http://localhost:5001                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Middleware Stack                                                        â”‚   â”‚
â”‚  â”‚ â”œâ”€ verifyToken() â†’ Extracts & validates JWT                            â”‚   â”‚
â”‚  â”‚ â”œâ”€ isAdmin() â†’ Checks req.user.user_type === 'admin'                   â”‚   â”‚
â”‚  â”‚ â””â”€ auditLog() â†’ Logs action with admin ID, IP, timestamp               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Route Handler: /api/admin/stats                                         â”‚   â”‚
â”‚  â”‚ POST /api/admin/stats â†’ adminStatsController.getStats()                â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ Request Body:                                                           â”‚   â”‚
â”‚  â”‚ {                                                                        â”‚   â”‚
â”‚  â”‚   startDate: "2024-11-01",                                             â”‚   â”‚
â”‚  â”‚   endDate: "2024-11-12",                                               â”‚   â”‚
â”‚  â”‚   userId: null                                                          â”‚   â”‚
â”‚  â”‚ }                                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Controller: adminStatsController.getStats()                            â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ 1. Parse & validate request                                            â”‚   â”‚
â”‚  â”‚    â”œâ”€ startDate: string â†’ Date object                                  â”‚   â”‚
â”‚  â”‚    â”œâ”€ endDate: string â†’ Date object                                    â”‚   â”‚
â”‚  â”‚    â””â”€ userId: optional filter                                          â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ 2. Build WHERE clause                                                   â”‚   â”‚
â”‚  â”‚    â”œâ”€ game.created_at BETWEEN startDate AND endDate                    â”‚   â”‚
â”‚  â”‚    â”œâ”€ game.settlement_status = 'settled'                               â”‚   â”‚
â”‚  â”‚    â””â”€ (if userId) bet_slip.user_id = userId                            â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ 3. Execute Queries (using TypeORM)                                     â”‚   â”‚
â”‚  â”‚    â”œâ”€ Query 1: Aggregate totals                                        â”‚   â”‚
â”‚  â”‚    â”œâ”€ Query 2: Per-card statistics                                     â”‚   â”‚
â”‚  â”‚    â”œâ”€ Query 3: Per-user statistics                                     â”‚   â”‚
â”‚  â”‚    â””â”€ Query 4: Unique user count                                       â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ 4. Calculate derived fields                                            â”‚   â”‚
â”‚  â”‚    â”œâ”€ profit = totalWagered - totalPayouts                             â”‚   â”‚
â”‚  â”‚    â”œâ”€ profitMargin = (profit / totalWagered) * 100                    â”‚   â”‚
â”‚  â”‚    â”œâ”€ winRate = (payoutCount / totalBetCount) * 100                   â”‚   â”‚
â”‚  â”‚    â””â”€ averageBet = totalWagered / totalBetCount                        â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ 5. Format response                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Database Queries                                                        â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ Repository 1: GameRepository                                           â”‚   â”‚
â”‚  â”‚ â”œâ”€ Create QueryBuilder                                                 â”‚   â”‚
â”‚  â”‚ â”œâ”€ WHERE: created_at BETWEEN startDate AND endDate                     â”‚   â”‚
â”‚  â”‚ â”œâ”€ WHERE: settlement_status = 'settled'                                â”‚   â”‚
â”‚  â”‚ â””â”€ COUNT(*) â†’ totalGames                                               â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ Repository 2: BetSlipRepository                                        â”‚   â”‚
â”‚  â”‚ â”œâ”€ Create QueryBuilder (with JOIN to games)                            â”‚   â”‚
â”‚  â”‚ â”œâ”€ WHERE: game.created_at BETWEEN startDate AND endDate                â”‚   â”‚
â”‚  â”‚ â”œâ”€ SUM(total_amount) â†’ totalWagered                                    â”‚   â”‚
â”‚  â”‚ â”œâ”€ SUM(payout_amount) â†’ totalPayouts                                   â”‚   â”‚
â”‚  â”‚ â”œâ”€ COUNT(DISTINCT user_id) â†’ uniqueUsers                              â”‚   â”‚
â”‚  â”‚ â””â”€ GROUP BY card_number â†’ cardStats                                    â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ Repository 3: GameCardTotalRepository                                  â”‚   â”‚
â”‚  â”‚ â”œâ”€ WHERE: game.created_at BETWEEN startDate AND endDate                â”‚   â”‚
â”‚  â”‚ â”œâ”€ GROUP BY card_number                                                â”‚   â”‚
â”‚  â”‚ â””â”€ Returns: Per-card totals                                            â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ Repository 4: UserRepository (optional)                                â”‚   â”‚
â”‚  â”‚ â””â”€ Fetch user details for top users                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP Response 200 OK
                 â”‚ Content-Type: application/json
                 â”‚
                 â–¼
        {
          "success": true,
          "data": {
            "totalGames": 288,
            "totalWagered": 1250000,
            "totalPayouts": 1100000,
            "profit": 150000,
            "profitMargin": "12.00%",
            "uniqueUsers": 450,
            "averageBet": 4340.28,
            "winRate": "45.5%",
            "cardStats": [
              {
                "card": 1,
                "totalBets": 100000,
                "totalPayouts": 90000,
                "betCount": 23,
                "winCount": 10
              },
              ...
            ],
            "userStats": [
              {
                "userId": "USER123",
                "userName": "John Doe",
                "gameCount": 45,
                "totalBet": 50000,
                "totalWon": 45000
              },
              ...
            ]
          }
        }
```

---

## ğŸ”„ Current vs Enhanced Data Flow

### CURRENT DATA FLOW (With Mock Data)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StatsPage Mount â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Call fetchStats()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Set Mock Data Directly       â”‚
â”‚ {                            â”‚
â”‚   totalUsers: 1250,          â”‚
â”‚   totalGames: 456,           â”‚
â”‚   totalWagered: 1250000,     â”‚
â”‚   totalPayouts: 1100000,     â”‚
â”‚   profit: 150000             â”‚
â”‚ }                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ setStats(mockData)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Re-render Component          â”‚
â”‚ Display Stats Cards          â”‚
â”‚ (Always same values)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ENHANCED DATA FLOW (With Real API)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StatsPage Mount                 â”‚
â”‚  + useEffect([startDate, endDate])
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Call statsService.getStats({           â”‚
â”‚   startDate: "2024-11-01",             â”‚
â”‚   endDate: "2024-11-12",               â”‚
â”‚   userId: selectedUser                 â”‚
â”‚ })                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Axios HTTP Client                      â”‚
â”‚ POST /api/admin/stats                  â”‚
â”‚ + Bearer Token (from interceptor)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ (Network request)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend Controller                     â”‚
â”‚ adminStatsController.getStats()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Database                         â”‚
â”‚ - games table                          â”‚
â”‚ - bet_slips table                      â”‚
â”‚ - game_card_totals table               â”‚
â”‚ - users table                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Aggregate & Calculate                  â”‚
â”‚ - SUM(wagered)                         â”‚
â”‚ - SUM(payouts)                         â”‚
â”‚ - COUNT(games)                         â”‚
â”‚ - Profit margin                        â”‚
â”‚ - Win rate                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response 200 OK                        â”‚
â”‚ {                                      â”‚
â”‚   success: true,                       â”‚
â”‚   data: { realStats... }               â”‚
â”‚ }                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ (Network response)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: setState(response.data)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component Re-renders                   â”‚
â”‚ Display Real Stats                     â”‚
â”‚ - Cards with real numbers              â”‚
â”‚ - Charts with real data                â”‚
â”‚ - Tables with real breakdown           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Database Query Breakdown

### Query 1: Main Aggregates
```sql
SELECT 
  COUNT(DISTINCT g.id) as total_games,
  SUM(bs.total_amount) as total_wagered,
  SUM(bs.payout_amount) as total_payouts,
  COUNT(DISTINCT bs.user_id) as unique_users,
  COUNT(bs.id) as total_bets
FROM games g
LEFT JOIN bet_slips bs ON g.game_id = bs.game_id
WHERE g.created_at BETWEEN ? AND ?
  AND g.settlement_status = 'settled'
  AND (? IS NULL OR bs.user_id = ?)
```

### Query 2: Per-Card Statistics
```sql
SELECT 
  gct.card_number,
  SUM(gct.total_bet_amount) as total_bets,
  SUM(bs.payout_amount) as total_payouts,
  COUNT(bs.id) as bet_count
FROM game_card_totals gct
LEFT JOIN bet_slips bs ON gct.game_id = bs.game_id 
  AND bs.card_number = gct.card_number
LEFT JOIN games g ON gct.game_id = g.game_id
WHERE g.created_at BETWEEN ? AND ?
  AND g.settlement_status = 'settled'
GROUP BY gct.card_number
ORDER BY gct.card_number
```

### Query 3: Per-User Statistics (Top 10)
```sql
SELECT 
  u.id,
  u.user_id,
  u.first_name,
  u.last_name,
  COUNT(DISTINCT bs.game_id) as game_count,
  SUM(bs.total_amount) as total_bet,
  SUM(bs.payout_amount) as total_won
FROM bet_slips bs
LEFT JOIN users u ON bs.user_id = u.id
LEFT JOIN games g ON bs.game_id = g.game_id
WHERE g.created_at BETWEEN ? AND ?
  AND g.settlement_status = 'settled'
GROUP BY u.id
ORDER BY SUM(bs.total_amount) DESC
LIMIT 10
```

---

## ğŸ“ State Management Flow

### Component State Tree
```
StatsPage Component State
â”œâ”€ stats: StatsData | null
â”‚  â”œâ”€ totalGames: number
â”‚  â”œâ”€ totalWagered: number
â”‚  â”œâ”€ totalPayouts: number
â”‚  â”œâ”€ profit: number
â”‚  â”œâ”€ profitMargin: string
â”‚  â”œâ”€ uniqueUsers: number
â”‚  â”œâ”€ averageBet: number
â”‚  â”œâ”€ winRate: string
â”‚  â”œâ”€ cardStats: CardStat[]
â”‚  â”‚  â”œâ”€ card: number
â”‚  â”‚  â”œâ”€ totalBets: number
â”‚  â”‚  â””â”€ totalPayouts: number
â”‚  â””â”€ userStats: UserStat[]
â”‚     â”œâ”€ userId: string
â”‚     â”œâ”€ userName: string
â”‚     â”œâ”€ totalBet: number
â”‚     â””â”€ totalWon: number
â”‚
â”œâ”€ isLoading: boolean
â”‚
â”œâ”€ error: string
â”‚
â”œâ”€ filters
â”‚  â”œâ”€ startDate: string (YYYY-MM-DD)
â”‚  â”œâ”€ endDate: string (YYYY-MM-DD)
â”‚  â””â”€ selectedUser: string | null
â”‚
â””â”€ users: User[]
   â”œâ”€ id: number
   â”œâ”€ user_id: string
   â”œâ”€ first_name: string
   â””â”€ last_name: string
```

### State Update Triggers
```
User Action
    â†“
Event Handler
    â†“
setState() call(s)
    â†“
useEffect dependency array changes
    â†“
useEffect callback executes
    â†“
async API call
    â†“
setState() with response
    â†“
Component re-renders
    â†“
DOM updates
```

---

## ğŸ” Authentication & Authorization Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Login              â”‚
â”‚ (authController.login) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Generate JWT Tokens                   â”‚
â”‚ â”œâ”€ accessToken (15 min expiry)        â”‚
â”‚ â””â”€ refreshToken (7 day expiry)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store Tokens                            â”‚
â”‚ â”œâ”€ localStorage.setItem('accessToken')  â”‚
â”‚ â””â”€ Cookies.set('kismatx_access_token')  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Request                              â”‚
â”‚ POST /api/admin/stats                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Axios Interceptor                        â”‚
â”‚ â”œâ”€ Read token from localStorage          â”‚
â”‚ â”œâ”€ Set Authorization header              â”‚
â”‚ â”‚  "Authorization: Bearer <token>"       â”‚
â”‚ â””â”€ Send request                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend Middleware                       â”‚
â”‚ â”œâ”€ verifyToken()                         â”‚
â”‚ â”‚  â”œâ”€ Extract token from header          â”‚
â”‚ â”‚  â”œâ”€ Verify JWT signature               â”‚
â”‚ â”‚  â”œâ”€ Check expiry                       â”‚
â”‚ â”‚  â””â”€ Set req.user = decoded payload     â”‚
â”‚ â”‚                                        â”‚
â”‚ â”œâ”€ isAdmin()                             â”‚
â”‚ â”‚  â”œâ”€ Check req.user.user_type           â”‚
â”‚ â”‚  â””â”€ Return 403 if not admin            â”‚
â”‚ â”‚                                        â”‚
â”‚ â””â”€ Request proceeds if all OK            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller Executes                      â”‚
â”‚ adminStatsController.getStats()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Response Structure

### Success Response
```typescript
{
  "success": true,
  "data": {
    "totalGames": 288,
    "totalWagered": 1250000,
    "totalPayouts": 1100000,
    "profit": 150000,
    "profitMargin": "12.00%",
    "uniqueUsers": 450,
    "averageBet": 4340.28,
    "winRate": "45.5%",
    "cardStats": [
      {
        "card": 1,
        "totalBets": 100000,
        "totalPayouts": 90000,
        "betCount": 23,
        "winCount": 10
      }
      // ... 11 more cards
    ],
    "userStats": [
      {
        "userId": "USER123",
        "userName": "John Doe",
        "gameCount": 45,
        "totalBet": 50000,
        "totalWon": 45000,
        "netProfit": -5000
      }
      // ... up to 10 users
    ]
  }
}
```

### Error Response
```typescript
{
  "success": false,
  "message": "Invalid date range",
  "error": {
    "code": "INVALID_DATE_RANGE",
    "details": "Start date cannot be after end date"
  }
}
```

---

Generated: 2024-11-12
Version: 1.0
Status: Complete
